@using System;
@using System.IO;
@using System.Text;
@using System.Text.RegularExpressions;
@using System.Net;
@using System.Web;
@using System.Collections.Specialized;
@using System.Dynamic;
@using SD = Simple.Data;
@using System.Web.Mvc;
@using System.Web.Helpers;
@{
    List<dynamic> registrationInfo = new List<dynamic>();
    var shipToStreet = "";
    var billingAddress = "";
    bool gotExpressCheckoutDetails = false;

    string token = Request["token"];
    string payerId = Request["PayerId"];
    string method = "GetExpressCheckoutDetails";

    //build action
    var strGetExpressCheckoutDetails = new StringBuilder();
    strGetExpressCheckoutDetails.Append("METHOD=");
    strGetExpressCheckoutDetails.Append(method);
    strGetExpressCheckoutDetails.Append("&VERSION=");
    strGetExpressCheckoutDetails.Append(App.ExpressCheckoutVersion);
    strGetExpressCheckoutDetails.Append("&USER=");
    strGetExpressCheckoutDetails.Append(App.PayPalUser);
    strGetExpressCheckoutDetails.Append("&PWD=");
    strGetExpressCheckoutDetails.Append(App.PayPalPassword);
    strGetExpressCheckoutDetails.Append("&SIGNATURE=");
    strGetExpressCheckoutDetails.Append(App.PayPalSignature);
    strGetExpressCheckoutDetails.Append("&TOKEN=");
    strGetExpressCheckoutDetails.Append(token);
    
    //Do Post
    DoPostPayPalData doPostToForGetDetails = new DoPostPayPalData(strGetExpressCheckoutDetails.ToString(), App.SandboxPayInfoUrl);
    string getDetatailsResponse = doPostToForGetDetails.Post();

    NameValueCollection getDetatailsResponseObj = HttpUtility.ParseQueryString(getDetatailsResponse); //Parse server response
    @getDetatailsResponseObj;
    if (getDetatailsResponseObj.Get("ACK") == "Success") {
        gotExpressCheckoutDetails = true;

        shipToStreet = getDetatailsResponseObj.Get("SHIPTOSTREET");
        billingAddress = getDetatailsResponseObj.Get("SHIPTOSTREET") + " " + getDetatailsResponseObj.Get("SHIPTOCITY") + ", " + getDetatailsResponseObj.Get("SHIPTOSTATE") + " " + getDetatailsResponseObj.Get("SHIPTOZIP");
       
        var db = SD.Database.OpenFile(Server.MapPath("~/App_Data/COGMOR.sdf"));

        registrationInfo = db.RegistrationDetails.All()
              .Join(db.Registration)
              .On(db.RegistrationDetails.ID == db.Registration.Id)
              .Select(
                db.Registration.Id, 
                db.Registration.Attendee, 
                db.RegistrationDetails.Address,
                db.RegistrationDetails.City,
                db.RegistrationDetails.State,
                db.RegistrationDetails.Zip,
                db.RegistrationDetails.Phone_Num,
                db.RegistrationDetails.Church,
                //db.RegistrationDetails.Attendees_Guests,
                db.RegistrationDetails.Num_Attending_Two_Days,
                db.RegistrationDetails.Num_Attending_One_Day,
                db.RegistrationDetails.Num_12andYounger_Attending,
                db.RegistrationDetails.Num_Golfing,
                db.RegistrationDetails.Num_Paintballing,
                db.RegistrationDetails.Num_Fishing,
                db.RegistrationDetails.Total_Paided)
              .Where(db.Registration.Id == 20130516222115)
              .ToList();

       

        if (IsPost) {
            App.ExpressCheckoutToken = getDetatailsResponseObj.Get("TOKEN");
  
            token = App.ExpressCheckoutToken;
            method = "DoExpressCheckoutPayment";
            
            //build action
            var strDoExpressCheckoutPayment = new StringBuilder();
            strDoExpressCheckoutPayment.Append("METHOD=");
            strDoExpressCheckoutPayment.Append(method);
            strDoExpressCheckoutPayment.Append("&VERSION=");
            strDoExpressCheckoutPayment.Append(App.ExpressCheckoutVersion);
            strDoExpressCheckoutPayment.Append("&USER=");
            strDoExpressCheckoutPayment.Append(App.PayPalUser);
            strDoExpressCheckoutPayment.Append("&PWD=");
            strDoExpressCheckoutPayment.Append(App.PayPalPassword);
            strDoExpressCheckoutPayment.Append("&SIGNATURE=");
            strDoExpressCheckoutPayment.Append(App.PayPalSignature);
            strDoExpressCheckoutPayment.Append("&TOKEN=");
            strDoExpressCheckoutPayment.Append(token);
            strDoExpressCheckoutPayment.Append("&PAYERID=");
            strDoExpressCheckoutPayment.Append(payerId);
            strDoExpressCheckoutPayment.Append("&PAYMENTREQUEST_0_PAYMENTACTION=");
            strDoExpressCheckoutPayment.Append(App.ExpressCheckoutPaymentAction);
            strDoExpressCheckoutPayment.Append("&PAYMENTREQUEST_0_CURRENCYCODE=");
            strDoExpressCheckoutPayment.Append(App.ExpressCheckoutCurrencyCode);
            strDoExpressCheckoutPayment.Append("&PAYMENTREQUEST_0_AMT=");
            strDoExpressCheckoutPayment.Append(getDetatailsResponseObj.Get("PAYMENTREQUEST_0_AMT"));
            strDoExpressCheckoutPayment.Append("&PAYMENTREQUEST_0_ITEMAMT=");
            strDoExpressCheckoutPayment.Append(getDetatailsResponseObj.Get("PAYMENTREQUEST_0_ITEMAMT"));

            //Do Post
            DoPostPayPalData doPostToComfirmPayment = new DoPostPayPalData(strDoExpressCheckoutPayment.ToString(), App.SandboxPayInfoUrl);
            string confirmPaymentResponse = doPostToComfirmPayment.Post();
            
            NameValueCollection confirmPaymentResponseObj = HttpUtility.ParseQueryString(confirmPaymentResponse); //Parse server response
     
            if (confirmPaymentResponseObj.Get("ACK") == "Success") {
                //Updated  database with succss order info from paypal
                dynamic expSuccess = new ExpandoObject();
                expSuccess.ID = confirmPaymentResponseObj["TOKEN"];

                db.DoExpressCheckoutSuccessDetails.Insert(expSuccess);

                //Send user email and copy email to info@ohiomensoxroast.org

               <p class="success">
                    Thank you for registering for the Ox Roast. When you arrive at the Ox Roast on Septermber 6th 2013 we will veify that you have registered for the Ox Roast. 
                    Below is a copy of your registration please print so that you have a copy for your records.You will not be required to show a copy of your registration the printing
                    of this page is purly for your benefit, however it may not hurt to have this copy with you as prof of payment incase your registration is lost.
               </p>
            } else {
                <p class="error">
                    The server could not process your request. 
                    If you see this message please contact us at info@ohiomensoxroast.org so that we can fix this issue quickly.
                </p>
            }
            
        }
    } else {
        <p class="error">
            The server could not process your request. 
            If you see this message please contact us at info@ohiomensoxroast.org so that we can fix this issue quickly.
        </p>
    }
}
<div class="registration-details">
    <p>Please review your order below and confirmation your payment. Note: Make sure you click confirm payment so that we may process your registration fully.</p>
    @if (gotExpressCheckoutDetails) {
        foreach (var info in registrationInfo) {
            NameValueCollection eventTotals = new NameValueCollection();

            eventTotals.Add(info.Num_Attending_Two_Days + " Two Day", Math.BigMul(info.Num_Attending_Two_Days, 65).ToString());
            eventTotals.Add(info.Num_Attending_One_Day + " One Day", Math.BigMul(info.Num_Attending_One_Day, 35).ToString());
            eventTotals.Add(info.Num_12andYounger_Attending + " 12 and under", Math.BigMul(info.Num_12andYounger_Attending, 25).ToString());
            eventTotals.Add(info.Num_Golfing + " Golfing", Math.BigMul(info.Num_Golfing, 45).ToString());
            eventTotals.Add(info.Num_Paintballing + " Painting", Math.BigMul(info.Num_Paintballing, 5).ToString());
            eventTotals.Add(info.Num_Fishing + " Fishing", Math.BigMul(info.Num_Fishing, 25).ToString());

            <h3>Registration/Billing Info</h3>
            <ul class="generalInfo">
                <li>
                    <h4>Confirmation #:</h4>
                    <span>@info.ID</span>
                </li>
			    <li>
				    <h4>Name:</h4>
				    <span>@info.Attendee</span> <!-- Ex. Smith, Bob -->
			    </li>
			    <li>
				    <h4>Registed Address:</h4>
				    <span>@info.Address @info.City, @info.State @info.Zip</span><!-- Ex. Street, State Zip -->
			    </li>
                <li>
                    <h4>Billing Address:</h4>
                    @if (info.Address != shipToStreet) {
                        <span>@billingAddress</span>
                    } else {
                        <span>Same as registered address</span>
                    }
                </li>
                @if (info.Phone_Num != null && info.Phone_Num != "") {
                    <li>
				        <h4>Phone Num:</h4>
				        <span>@info.Phone_Num</span> <!-- Ex. 740.497.2943 -->
                    </li>
                }
                @if (info.Church != null && info.Church != "") {
			        <li>
				        <h4>Church Attending:</h4>
				        <span>@info.Church</span>
			        </li>
                }
			    <!--<li>
				    <h4>Guest</h4>
				    <ul>
					    <li>guest1</li>
					    <li>guest2</li>
					    <li>guest3</li>
					    <li>guest4</li>
				    </ul>
			    </li>-->
		    </ul>
            <h3>Event Pricing Info</h3>
		    <ul class="pricingInfo">
                @foreach (var evt in eventTotals.AllKeys) {
                    if (int.Parse(eventTotals[evt]) > 0 ) {
                        <li>
				            <h4>@evt</h4>
				            <span>@eventTotals[evt]</span>
			            </li>   
                    }
                }
			    <li>
				    <h4>Total</h4>
				    <span>@info.Total_Paided</span>
			    </li>
		    </ul>
        }
        <form action="" method="post">
            <fieldset>
                <input type="submit" class="confirm" value="Confirm Payment"/>
            </fieldset>
        </form>
    }
</div>